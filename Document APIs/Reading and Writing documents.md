# 读写文档

## 介绍

Elasticsearch中的索引被分成多个分片，每个分片会有多个副本。这些副本被称为`副本组`，并且在添加或删除文档时必须保持同步。如果这个过程失败了，从一个副本中读取的数据将和另一个副本中读取的数据不同。保持分片分本同步并提供从中读取的过程被称为`数据复制模型`。

Elasticsearch的数据复制模型基于主要备份模型(primary-backup model)，在Microsoft Research的`PacificA paper`中有详细描述。该模型中，`副本组`中有一个副本作为主分片。其他副本被称为`副本碎片`。主分片作为所有索引操作的主要入口点，它负责验证索引并保证索引是正确的。一旦主分片接受了索引操作，主分片还负责将索引操作复制到其他副本。

本节的目的是对Elasticsearch的复制模型进行高级别上的概述，并讨论它对写操作和读操作之间的各种交互的影响。

## 基本写模型

Elasticsearch中的每个索引操作首先通过路由（通常基于文档ID）解析到复制组。一旦确定了复制组，操作会在内部被转发到复制组的主分片。主分片负责校验操作且将操作转发到其他的分片中。因为副本可以脱机，所以主分片不需要复制到所有的分片中。相反，Elasticsearch维护应该接受操作的分片列表。这个列表称为`同步副本`，由主节点维护。顾名思义，这些是“好”的分片副本的集合，其保证执行了向用户确认的所有索引和删除操作。主分片负责维护此不变量，因此必须将所有操作复制到此集合中的每个副本。

主分片遵循以下步骤：

1. 验证输入的操作，拒绝结构上无效的操作。（比如，在数字字段上输入对象）
2. 在本地执行操作，比如索引或删除关联的文档。这个步骤也会校验字段的内容，需要的拒绝该操作。（比如：对Lucene来说太长的关键词值）
3. 将操作转发到当前`同步副本`中的每个副本。如果有多个副本，并行执行。
4. 当所有的副本成功执行操作后，回复主分片，主分片将完成此操作的信息返回给用户。

### 故障处理

索引过程中可能有很多错误发生——磁盘可能会损坏，节点之间可能会断开连接，某些错误的配置可能导致副本中的操作失败尽管主分片中已经执行成功。这些错误不会频繁发生，但是主分片必须负责处理这些错误。

如果主分片本身发生了错误，托管主分片的节点将向主节点发送有关它的消息。索引操作将等待（默认情况下最多1分钟）主服务器将其中一个副本提升新的主分片。接下去的操作将被被转发到新的主分片来处理。注意，主节点也监控节点的健康，可以决定主动降级主分片。这通常发生在持有主分片的节点因为网络问题与集群隔离。

当主分片上成功执行了操作，主节点就必须处理在分片副本上执行时的潜在故障。这可能是由副本中的实际故障导致或由于网络问题阻止操作到达副本（或组织副本响应）而导致的。这些故障都有一个相同的结果：同步副本集中的副本丢失操作的确认。为了避免违反不变量，主分片向主节点发送请求将有问题的分片从同步副本集中移除。一旦分片的删除由主节点确认，主分片确认操作。注意，主节点还会指示另一个节点开始构建新的分片副本，以便将系统恢复到正常状态。

在将操作转发到副本时，主分片会使用副本来验证它仍然是活动的主副本。如果主分片由于网络分区（或长时间GC）而被隔离，则它可以继续处理输入的索引操作，直到意识到其已被降级。来自过期主分片的会被副本拒绝。当主分片收到副本因为它不再是主分片而拒绝请求的响应时，它会访问主节点并获知它已被替换。然后操纵会被路由到新的主分片。

> 如果没有副本会发生什么？这是一个有效的场景，可能由于索引的配置或者简单的因为所有副本都失效了。这这种情况下，主分片将在没有任何外部验证的情况下处理操作，这可能看起来有问题。换句话说，主分片本省不能将其他分片失效，除了请求主节点代表它来这样做。这意味着主节点知道主分片是唯一有效的拷贝。因此，我们保证主节点不会将任何其他分片副本（过期的）提升为新的主分片，这样索引到主分片的的操作不会丢失。当然，由于我们只运行一个数据副本，物理硬件问题可能会导致数据丢失。有关一些缓解选项，请参阅"Wait For Active Shards"一节。

## 基本读模型

在Elasticsearch中读可以是轻量级的通过ID查询，或者具有复杂聚合的重量级搜索。主分片备份模型的一个优点是所有的分片副本都保持一致（除了正在执行的操作）。因此，单个同步副本副本足够满足读取请求。

当节点收到读请求时，该节点负责将其转发到保存相关分片的节点，整理响应并会返回给客户。我们将请求中的该节点称为协调节点。基本流程如下：

1. 将读请求解析到相关分片。注意，由于大多数搜索将被发送到一个或多个索引，所以通常需要从多个分片中读取，每个分片表示数据的不同子集。
2. 从分片副本组中选择每个相关分片的活动副本。可以是主分片或者副本。默认情况下，Elasticsearch将简单地在分片副本之间循环。
3. 发送分片级别的读请求到选择的副本。
4. 整合结果并发送响应。注意，通过ID来查询的情况下，只有一个分片是相关的，这一步可以跳过。

### 故障处理

当分片未能响应读取请求时，协调节点会从相同的副本组中选择另一个副本，并将分片级别的搜索请求发送到该副本。重复故障可能导致没有分片副本可用。在某些情况下，例如`_search`，Elasticsearch将更喜欢快速响应，即使获取部分结果，而不是等待问题得到解决（部分结果在响应的_shards头中指示）。

## 一些简单的含义

每个基本流程确定Elasticsearch如何作为系统来读取和写入。此外，由于读写请求可以同时执行，这两个基本流程相互交互。有一些固有的含义：

- Efficient reads（有效读操作）：在正常操作下，每个相关的副本组执行一次读操作。只有在故障条件下同一分片的多个副本才执行相同的搜索。
- Read unacknowledged（读操作未答复）：由于主分片首先在本地索引，然后复制请求，并发读取可能在它被确认之前已经看到了更改。
- Two copies by defalut（默认两个副本）：该模型可以是容错的，同时仅保留数据的两个副本。这与基于仲裁的系统形成对比，其中容错的最小拷贝数为3。

## 故障

在故障条件下，以下是可能的：

- 单个分片可能会减慢索引：因为主分片在每个操作中都会等待同步副本中所有的副本，一个缓慢的分片就会减慢整个副本组的速度。这是我们为上述读取效率付出的代价。当然，当个缓慢的分片也会减慢不幸路由到它的搜索。
- 脏读：隔离的主分片可以暴露不被确认的写入。这是由于以下事实造成的：隔离的主分片只会在向其副本发送请求或者访问主节点是才会意识到它是隔离的。此时，操作已经索引到主分片中，并且可以并发读取。Elasticsearch通过每秒钟ping主节点，如果没有主节点则拒绝索引操作，来缓解风险。

## 冰山一角

本文档提供了Elasticsearch如何处理数据的高级概述。当然，还有很多事情要做。类似主分词、集群状态发布、主节点选举等都在保持系统正常运行方面发挥作用。本文档也不包括已知和重要的错误（包括解决的和正在解决的）。我们认识到GitHub很难跟上。为了帮助人们留在这些人，我们在我们的网站上保持专门的弹性页面。我们强烈建议阅读。

